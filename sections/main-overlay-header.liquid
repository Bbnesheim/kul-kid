{% assign overlay_id = section.id | replace: '_', '' | downcase %}

{% style %}
  .main-overlay-header-{{ overlay_id }} {
    --kk-icon-size-desktop: {{ section.settings.icon_size_desktop | default: 28 }}px;
    --kk-icon-size-mobile: {{ section.settings.icon_size_mobile | default: 24 }}px;
    --overlay-header-rainbow-gradient: linear-gradient(
      90deg,
      #ff0000,
      #ff8000,
      #ffff00,
      #80ff00,
      #00ff00,
      #00ff80,
      #00ffff,
      #0080ff,
      #0000ff,
      #8000ff,
      #ff00ff,
      #ff0080
    );
    --overlay-header-rainbow-transition: 0.35s ease;
    position: relative;
    width: 100%;
    background-color: {{ section.settings.header_bg_color }};
    border-bottom: {{ section.settings.header_border_thickness }}px solid {{ section.settings.header_border_color }};
    z-index: 1000;
  }

  /* KK ICON HARD RESET */
  .main-overlay-header-{{ overlay_id }} .header__icon svg,
  .main-overlay-header-{{ overlay_id }} .header__icon svg *,
  .main-overlay-header-{{ overlay_id }} .header__icon .icon-wrapper {
    background: none !important;
    -webkit-background-clip: initial !important;
    -webkit-text-fill-color: initial !important;
    mask: none !important;
    -webkit-mask: none !important;
    opacity: 1 !important;
  }

  .main-overlay-header-container-{{ overlay_id }} {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: {{ section.settings.header_margin_mobile }}px;
    height: {{ section.settings.header_height_mobile }}px;
    max-width: {{ settings.page_width }}px;
    margin: 0 auto;
    position: relative;
    z-index: 1002;
    background-color: inherit;
  }

  .main-overlay-header-logo-{{ overlay_id }} {
    flex-shrink: 0;
  }

  .main-overlay-header-logo-{{ overlay_id }} a {
    display: block;
  }

  .main-overlay-header-logo-{{ overlay_id }} img {
    height: {{ section.settings.logo_height_mobile }}px;
    width: auto;
  }

  .main-overlay-header-logo-text-{{ overlay_id }} {
    display: inline-block;
    font-weight: 700;
    font-size: calc({{ section.settings.logo_height_mobile }}px * 0.6);
    line-height: 1;
    color: {{ section.settings.nav_text_color }};
    letter-spacing: 0.05em;
    white-space: nowrap;
  }

  .main-overlay-header-nav-desktop-{{ overlay_id }} {
    display: none;
    flex: 1;
    justify-content: center;
    margin: 0 {{ section.settings.nav_spacing_desktop }}px;
  }

  .main-overlay-header-nav-list-{{ overlay_id }} {
    display: flex;
    list-style: none;
    margin: 0;
    padding: 0;
    gap: {{ section.settings.nav_item_spacing_desktop }}px;
    align-items: center;
  }

  .main-overlay-header-nav-item-{{ overlay_id }} {
    position: relative;
  }

  .main-overlay-header-nav-link-{{ overlay_id }} {
    color: {{ section.settings.nav_text_color }};
    text-decoration: none;
    font-size: {{ section.settings.nav_font_size_desktop }}px;
    font-weight: {{ section.settings.nav_font_weight }};
    padding: {{ section.settings.nav_item_padding_desktop }}px;
    display: block;
    position: relative;
    transition: color var(--overlay-header-rainbow-transition), background var(--overlay-header-rainbow-transition);
  }

  .main-overlay-header-nav-link-{{ overlay_id }}:hover {
    background: var(--overlay-header-rainbow-gradient);
    background-size: 200% 100%;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    animation: mh-rainbow-underline-{{ overlay_id }} var(--overlay-header-rainbow-transition);
  }

  .main-overlay-header-nav-link-{{ overlay_id }}::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    width: 0;
    height: 2px;
    background: var(--overlay-header-rainbow-gradient);
    transition: width var(--overlay-header-rainbow-transition);
  }

  .main-overlay-header-nav-link-{{ overlay_id }}:hover::after {
    width: 100%;
  }

  .main-overlay-header-dropdown-{{ overlay_id }} {
    position: absolute;
    top: 100%;
    left: 0;
    background-color: {{ section.settings.dropdown_bg_color }};
    border: 1px solid {{ section.settings.dropdown_border_color }};
    border-radius: {{ section.settings.dropdown_border_radius }}px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    opacity: 0;
    visibility: hidden;
    transform: translateY(-10px);
    transition: all 0.3s ease;
    min-width: 200px;
    z-index: 1001;
  }

  .main-overlay-header-nav-item-{{ overlay_id }}:hover .main-overlay-header-dropdown-{{ overlay_id }} {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
  }

  .main-overlay-header-dropdown-link-{{ overlay_id }} {
    display: block;
    padding: 12px 16px;
    color: {{ section.settings.dropdown_text_color }};
    text-decoration: none;
    font-size: {{ section.settings.dropdown_font_size }}px;
    transition: background-color 0.3s ease;
  }

  .main-overlay-header-dropdown-link-{{ overlay_id }}:hover {
    background-color: {{ section.settings.dropdown_hover_bg_color }};
    color: {{ section.settings.dropdown_hover_text_color }};
  }

  .main-overlay-header-actions-{{ overlay_id }} {
    display: flex;
    align-items: center;
    gap: {{ section.settings.icon_spacing }}px;
  }

  .main-overlay-header-actions-desktop-{{ overlay_id }} {
    display: none;
  }

  .main-overlay-header-icon-{{ overlay_id }} {
    position: relative;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    transition: transform var(--overlay-header-rainbow-transition);
  }

  .main-overlay-header-icon-{{ overlay_id }} img {
    width: 100%;
    height: 100%;
    display: block;
    transition: transform var(--overlay-header-rainbow-transition);
    object-fit: contain;
  }

  .main-overlay-header-icon-{{ overlay_id }}::after {
    content: none !important;
  }

  .main-overlay-header-gradient-{{ overlay_id }} stop {
    stop-color: var(--ai-overlay-stop-color);
    animation: mh-overlay-header-gradient-shift-{{ overlay_id }} 1.2s linear forwards;
    animation-delay: calc(var(--ai-overlay-stop-index) * 0.08s);
    animation-play-state: paused;
  }

  .main-overlay-header-gradient-{{ overlay_id }}.mh-animate stop {
    animation-play-state: running;
  }

  .main-overlay-header-icon-{{ overlay_id }}.mh-rainbow-active svg path,
  .main-overlay-header-icon-{{ overlay_id }}.mh-rainbow-active svg rect,
  .main-overlay-header-icon-{{ overlay_id }}.mh-rainbow-active svg circle,
  .main-overlay-header-icon-{{ overlay_id }}.mh-rainbow-active svg ellipse,
  .main-overlay-header-icon-{{ overlay_id }}.mh-rainbow-active svg polygon,
  .main-overlay-header-icon-{{ overlay_id }}.mh-rainbow-active svg polyline,
  .main-overlay-header-icon-{{ overlay_id }}.mh-rainbow-active svg line {
    fill: url(#mh-rainbow-icon-gradient-{{ overlay_id }});
  }

  @media (min-width: 990px) {
    .main-overlay-header-{{ overlay_id }} .header__icon svg {
      width: var(--kk-icon-size-desktop);
      height: var(--kk-icon-size-desktop);
    }
  }

  @media (max-width: 989.98px) {
    .main-overlay-header-{{ overlay_id }} .header__icon svg {
      width: var(--kk-icon-size-mobile);
      height: var(--kk-icon-size-mobile);
    }
  }

  .main-overlay-header-{{ overlay_id }} .main-overlay-header-actions-{{ overlay_id }},
  .main-overlay-header-{{ overlay_id }} .main-overlay-header-actions-desktop,
  .main-overlay-header-{{ overlay_id }} .main-overlay-header-actions-desktop-{{ overlay_id }},
  .main-overlay-header-{{ overlay_id }} .header__icon,
  .main-overlay-header-{{ overlay_id }} .header__icon .icon-wrapper,
  .main-overlay-header-{{ overlay_id }} .header__icon svg {
    overflow: visible !important;
  }

  .main-overlay-header-{{ overlay_id }} .header__icon {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    line-height: 0;
    min-width: max(var(--kk-icon-size-desktop), var(--kk-icon-size-mobile));
    min-height: max(var(--kk-icon-size-desktop), var(--kk-icon-size-mobile));
  }

  .main-overlay-header-{{ overlay_id }} .header__icon::after {
    display: none !important;
  }

  .main-overlay-header-{{ overlay_id }} .header__icon,
  .main-overlay-header-{{ overlay_id }} .icon-wrapper {
    transform: none !important;
  }

  .main-overlay-header-{{ overlay_id }} .header__icon .icon-wrapper {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    line-height: 0;
    box-sizing: content-box;
    padding: 0;
  }

  .main-overlay-header-{{ overlay_id }} .header__icon svg {
    display: block;
    vertical-align: middle;
  }

  .main-overlay-header-{{ overlay_id }} .header__icon svg path {
    fill: currentColor !important;
    transition: fill .35s ease;
    stroke: none !important;
    vector-effect: non-scaling-stroke;
  }

  .main-overlay-header-hamburger-{{ overlay_id }} {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    background: none;
    border: none;
    cursor: pointer;
    padding: 0;
    z-index: 1002;
    position: relative;
    width: 44px;
    height: 44px;
    touch-action: manipulation;
  }

  .main-overlay-header-hamburger-line-{{ overlay_id }} {
    width: 24px;
    height: 2px;
    background-color: {{ section.settings.hamburger_color }};
    margin: 2px 0;
    transition: all 0.3s ease;
  }

  .main-overlay-header-hamburger-{{ overlay_id }}.active .main-overlay-header-hamburger-line-{{ overlay_id }}:nth-child(1) {
    transform: rotate(45deg) translate(5px, 5px);
  }

  .main-overlay-header-hamburger-{{ overlay_id }}.active .main-overlay-header-hamburger-line-{{ overlay_id }}:nth-child(2) {
    opacity: 0;
  }

  .main-overlay-header-hamburger-{{ overlay_id }}.active .main-overlay-header-hamburger-line-{{ overlay_id }}:nth-child(3) {
    transform: rotate(-45deg) translate(7px, -6px);
  }

  .main-overlay-header-mobile-overlay-{{ overlay_id }} {
    position: fixed;
    top: var(--overlay-offset-{{ overlay_id }}, 0);
    left: 0;
    width: 100%;
    height: calc(100vh - var(--overlay-offset-{{ overlay_id }}, 0));
    background-color: {{ section.settings.overlay_bg_color }};
    z-index: 1001;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
  }

  .main-overlay-header-mobile-overlay-{{ overlay_id }}.active {
    opacity: 1;
    visibility: visible;
  }

  .main-overlay-header-mobile-overlay-content-{{ overlay_id }} {
    padding: {{ section.settings.overlay_padding_mobile }}px {{ section.settings.header_margin_mobile }}px;
  }

  .main-overlay-header-mobile-nav-{{ overlay_id }} {
    list-style: none;
    margin: 0;
    padding: 0;
  }

  .main-overlay-header-mobile-nav-item-{{ overlay_id }} {
    margin-bottom: {{ section.settings.nav_item_spacing_mobile }}px;
  }

  .main-overlay-header-mobile-nav-link-{{ overlay_id }} {
    display: flex;
    align-items: center;
    justify-content: flex-start;
    gap: {{ section.settings.caret_spacing }}px;
    width: 100%;
    color: {{ section.settings.overlay_text_color }};
    text-decoration: none;
    font-size: {{ section.settings.nav_font_size_mobile }}px;
    font-weight: {{ section.settings.nav_font_weight }};
    padding: {{ section.settings.nav_item_padding_mobile }}px 0;
    transition: all 0.3s ease;
  }

  .main-overlay-header-mobile-nav-link-{{ overlay_id }}:active {
    background: linear-gradient(90deg, #ff0000, #ff8000, #ffff00, #80ff00, #00ff00, #00ff80, #00ffff, #0080ff, #0000ff, #8000ff, #ff00ff, #ff0080);
    background-size: 200% 100%;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    animation: mh-rainbow-press-{{ overlay_id }} 0.3s ease-in-out;
  }

  .main-overlay-header-mobile-nav-label-{{ overlay_id }} {
    flex: 1;
    text-align: left;
    min-width: 0;
  }

  .main-overlay-header-caret-{{ overlay_id }} {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    margin-left: {{ section.settings.caret_margin }}px;
    transition: transform 0.3s ease;
    transform-origin: center;
  }

  .main-overlay-header-caret-symbol-{{ overlay_id }} {
    display: inline-block;
    font-size: {{ section.settings.caret_size }}px;
    line-height: 1;
    background: linear-gradient(90deg, #ff0000, #ff8000, #ffff00, #80ff00, #00ff00, #00ff80, #00ffff, #0080ff, #0000ff, #8000ff, #ff00ff, #ff0080);
    -webkit-background-clip: text;
    background-clip: text;
    color: transparent;
  }

  .main-overlay-header-caret-{{ overlay_id }} img,
  .main-overlay-header-caret-{{ overlay_id }} svg {
    width: {{ section.settings.caret_size }}px;
    height: {{ section.settings.caret_size }}px;
  }

  .main-overlay-header-mobile-nav-link-{{ overlay_id }}.active .main-overlay-header-caret-{{ overlay_id }} {
    transform: rotate(90deg);
  }

  .main-overlay-header-mobile-dropdown-{{ overlay_id }} {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease;
    margin-left: {{ section.settings.dropdown_indent_mobile }}px;
  }

  .main-overlay-header-mobile-dropdown-{{ overlay_id }}.active {
    max-height: 500px;
  }

  .main-overlay-header-mobile-dropdown-link-{{ overlay_id }} {
    display: block;
    color: {{ section.settings.overlay_text_color }};
    text-decoration: none;
    font-size: {{ section.settings.dropdown_font_size }}px;
    padding: 8px 0;
    opacity: 0.8;
    transition: opacity 0.3s ease;
  }

  .main-overlay-header-mobile-dropdown-link-{{ overlay_id }}:hover {
    opacity: 1;
  }

  .main-overlay-header-mobile-icons-{{ overlay_id }} {
    display: flex;
    justify-content: center;
    gap: {{ section.settings.icon_spacing }}px;
    margin-top: 30px;
    padding-top: 20px;
    border-top: 1px solid {{ section.settings.dropdown_border_color }};
  }

  @keyframes mh-overlay-header-gradient-shift-{{ overlay_id }} {
    0%,
    40%,
    100% {
      stop-color: var(--ai-overlay-stop-color);
    }
    50% {
      stop-color: #ffffff;
    }
    60% {
      stop-color: var(--ai-overlay-stop-color);
    }
  }

  @keyframes mh-rainbow-underline-{{ overlay_id }} {
    0% { background-position: 0% 50%; }
    100% { background-position: 200% 50%; }
  }

  @keyframes mh-rainbow-press-{{ overlay_id }} {
    0% { background-position: 0% 50%; }
    100% { background-position: 200% 50%; }
  }

  @media screen and (min-width: 750px) {
    .main-overlay-header-container-{{ overlay_id }} {
      padding: {{ section.settings.header_margin_desktop }}px;
      height: {{ section.settings.header_height_desktop }}px;
    }

    .main-overlay-header-logo-{{ overlay_id }} img {
      height: {{ section.settings.logo_height_desktop }}px;
    }

    .main-overlay-header-logo-text-{{ overlay_id }} {
      font-size: calc({{ section.settings.logo_height_desktop }}px * 0.6);
    }

    .main-overlay-header-nav-desktop-{{ overlay_id }} {
      display: flex;
    }

    .main-overlay-header-hamburger-{{ overlay_id }} {
      display: none;
    }

    .main-overlay-header-actions-desktop-{{ overlay_id }} {
      display: flex;
    }

    .main-overlay-header-icon-{{ overlay_id }} {
      width: var(--kk-icon-size-desktop);
      height: var(--kk-icon-size-desktop);
    }

    .main-overlay-header-actions-desktop-{{ overlay_id }} .main-overlay-header-icon-{{ overlay_id }} {
      --main-overlay-header-icon-base-color: {{ section.settings.search_icon_color_desktop }};
      --icon-base: var(--main-overlay-header-icon-base-color);
      color: var(--main-overlay-header-icon-base-color);
      position: relative;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .main-overlay-header-actions-desktop-{{ overlay_id }} .main-overlay-header-account-icon-{{ overlay_id }} {
      --main-overlay-header-icon-base-color: {{ section.settings.account_icon_color_desktop }};
      --icon-base: var(--main-overlay-header-icon-base-color);
      color: var(--main-overlay-header-icon-base-color);
    }

    .main-overlay-header-actions-desktop-{{ overlay_id }} .main-overlay-header-search-icon-{{ overlay_id }} {
      --main-overlay-header-icon-base-color: {{ section.settings.search_icon_color_desktop }};
      --icon-base: var(--main-overlay-header-icon-base-color);
      color: var(--main-overlay-header-icon-base-color);
    }

    .main-overlay-header-actions-desktop-{{ overlay_id }} .main-overlay-header-cart-icon-{{ overlay_id }} {
      --main-overlay-header-icon-base-color: {{ section.settings.cart_icon_color_desktop }};
      --icon-base: var(--main-overlay-header-icon-base-color);
      color: var(--main-overlay-header-icon-base-color);
    }

  }
{% endstyle %}

<main-overlay-header-{{ overlay_id }} class="main-overlay-header-{{ overlay_id }}" data-section-id="{{ section.id }}">
  <svg aria-hidden="true" focusable="false" width="0" height="0" style="position:absolute; left:0; top:0; pointer-events:none;">
    <defs>
      <linearGradient id="mh-rainbow-icon-gradient-{{ overlay_id }}" class="main-overlay-header-gradient-{{ overlay_id }}" x1="0" y1="0" x2="1" y2="0" gradientUnits="objectBoundingBox">
        <stop offset="0%"   stop-color="#ff0000" style="--ai-overlay-stop-index: 0; --ai-overlay-stop-color: #ff0000;"></stop>
        <stop offset="16%"  stop-color="#ff8000" style="--ai-overlay-stop-index: 1; --ai-overlay-stop-color: #ff8000;"></stop>
        <stop offset="33%"  stop-color="#ffff00" style="--ai-overlay-stop-index: 2; --ai-overlay-stop-color: #ffff00;"></stop>
        <stop offset="50%"  stop-color="#00ff00" style="--ai-overlay-stop-index: 3; --ai-overlay-stop-color: #00ff00;"></stop>
        <stop offset="66%"  stop-color="#0000ff" style="--ai-overlay-stop-index: 4; --ai-overlay-stop-color: #0000ff;"></stop>
        <stop offset="83%"  stop-color="#8000ff" style="--ai-overlay-stop-index: 5; --ai-overlay-stop-color: #8000ff;"></stop>
        <stop offset="100%" stop-color="#ff00ff" style="--ai-overlay-stop-index: 6; --ai-overlay-stop-color: #ff00ff;"></stop>
      </linearGradient>
    </defs>
  </svg>

  <div class="main-overlay-header-container-{{ overlay_id }}">
    <div class="main-overlay-header-logo-{{ overlay_id }}">
      <a href="{{ routes.root_url }}">
        {% if section.settings.logo %}
          {{ section.settings.logo | image_url: width: 300 | image_tag: alt: shop.name, loading: 'lazy' }}
        {% elsif settings.logo %}
          {{ settings.logo | image_url: width: 300 | image_tag: alt: shop.name, loading: 'lazy' }}
        {% else %}
          <span class="main-overlay-header-logo-text-{{ overlay_id }}">BRAND LOGO</span>
        {% endif %}
      </a>
    </div>

    <nav class="main-overlay-header-nav-desktop-{{ overlay_id }}">
      <ul class="main-overlay-header-nav-list-{{ overlay_id }}">
        {% for link in section.settings.menu.links %}
          <li class="main-overlay-header-nav-item-{{ overlay_id }}">
            <a href="{{ link.url }}" class="main-overlay-header-nav-link-{{ overlay_id }}">
              {{ link.title }}
            </a>
            {% if link.links.size > 0 %}
              <div class="main-overlay-header-dropdown-{{ overlay_id }}">
                {% for child_link in link.links %}
                  <a href="{{ child_link.url }}" class="main-overlay-header-dropdown-link-{{ overlay_id }}">
                    {{ child_link.title }}
                  </a>
                {% endfor %}
              </div>
            {% endif %}
          </li>
        {% endfor %}
      </ul>
    </nav>

    <div class="main-overlay-header-actions-{{ overlay_id }}">
      <div class="main-overlay-header-actions-desktop-{{ overlay_id }}">
        {% if section.settings.show_search %}
          <a href="{{ routes.search_url }}" class="header__icon main-overlay-header-icon-{{ overlay_id }} main-overlay-header-search-icon-{{ overlay_id }}">
            <span class="icon-wrapper">
              {% if section.settings.custom_search_icon %}
                {{ section.settings.custom_search_icon | image_url: width: 30 | image_tag: alt: 'Search', loading: 'lazy' }}
              {% else %}
                <svg viewBox="0 0 24 24" fill="currentColor">
                  <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                </svg>
              {% endif %}
            </span>
          </a>
        {% endif %}

        {% if section.settings.show_account %}
          <a href="{{ routes.account_url }}" class="header__icon main-overlay-header-icon-{{ overlay_id }} main-overlay-header-account-icon-{{ overlay_id }}">
            <span class="icon-wrapper">
              {% if section.settings.custom_account_icon %}
                {{ section.settings.custom_account_icon | image_url: width: 30 | image_tag: alt: 'Account', loading: 'lazy' }}
              {% else %}
                <svg viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                </svg>
              {% endif %}
            </span>
          </a>
        {% endif %}

        <a href="{{ routes.cart_url }}" class="header__icon main-overlay-header-icon-{{ overlay_id }} main-overlay-header-cart-icon-{{ overlay_id }}">
          <span class="icon-wrapper">
            {% if section.settings.custom_cart_icon %}
              {{ section.settings.custom_cart_icon | image_url: width: 30 | image_tag: alt: 'Cart', loading: 'lazy' }}
            {% else %}
              <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" focusable="false">
                <g transform="translate(0.5,0.5) scale(0.96)">
                  <path d="M7 18c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.19 2 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12L8.1 13h7.45c.75 0 1.41-.41 1.75-1.03L21.7 4H5.21l-.94-2H1zm16 16c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/>
                </g>
              </svg>
            {% endif %}
          </span>
        </a>
      </div>

      <button class="main-overlay-header-hamburger-{{ overlay_id }}" type="button" aria-label="Toggle menu" aria-controls="main-overlay-{{ overlay_id }}">
        <span class="main-overlay-header-hamburger-line-{{ overlay_id }}"></span>
        <span class="main-overlay-header-hamburger-line-{{ overlay_id }}"></span>
        <span class="main-overlay-header-hamburger-line-{{ overlay_id }}"></span>
      </button>
    </div>
  </div>

  <div id="main-overlay-{{ overlay_id }}" class="main-overlay-header-mobile-overlay-{{ overlay_id }}">
    <div class="main-overlay-header-mobile-overlay-content-{{ overlay_id }}">
      <ul class="main-overlay-header-mobile-nav-{{ overlay_id }}">
        {% for link in section.settings.menu.links %}
          <li class="main-overlay-header-mobile-nav-item-{{ overlay_id }}">
            <a href="{{ link.url }}" class="main-overlay-header-mobile-nav-link-{{ overlay_id }}" data-has-dropdown="{% if link.links.size > 0 %}true{% else %}false{% endif %}">
              <span class="main-overlay-header-mobile-nav-label-{{ overlay_id }}">{{ link.title }}</span>
              {% if link.links.size > 0 %}
                <span class="main-overlay-header-caret-{{ overlay_id }}">
                  {% if section.settings.custom_caret_icon %}
                    {{ section.settings.custom_caret_icon | image_url: width: 20 | image_tag: alt: 'Dropdown', loading: 'lazy' }}
                  {% else %}
                    <span class="main-overlay-header-caret-symbol-{{ overlay_id }}">â–¼</span>
                  {% endif %}
                </span>
              {% endif %}
            </a>
            {% if link.links.size > 0 %}
              <div class="main-overlay-header-mobile-dropdown-{{ overlay_id }}">
                {% for child_link in link.links %}
                  <a href="{{ child_link.url }}" class="main-overlay-header-mobile-dropdown-link-{{ overlay_id }}">
                    {{ child_link.title }}
                  </a>
                {% endfor %}
              </div>
            {% endif %}
          </li>
        {% endfor %}
      </ul>

      <div class="main-overlay-header-mobile-icons-{{ overlay_id }}">
        {% if section.settings.show_search %}
          <a href="{{ routes.search_url }}" class="header__icon main-overlay-header-icon-{{ overlay_id }} main-overlay-header-search-icon-{{ overlay_id }}">
            <span class="icon-wrapper">
              {% if section.settings.custom_search_icon %}
                {{ section.settings.custom_search_icon | image_url: width: 30 | image_tag: alt: 'Search', loading: 'lazy' }}
              {% else %}
                <svg viewBox="0 0 24 24" fill="currentColor">
                  <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                </svg>
              {% endif %}
            </span>
          </a>
        {% endif %}

        {% if section.settings.show_account %}
          <a href="{{ routes.account_url }}" class="header__icon main-overlay-header-icon-{{ overlay_id }} main-overlay-header-account-icon-{{ overlay_id }}">
            <span class="icon-wrapper">
              {% if section.settings.custom_account_icon %}
                {{ section.settings.custom_account_icon | image_url: width: 30 | image_tag: alt: 'Account', loading: 'lazy' }}
              {% else %}
                <svg viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                </svg>
              {% endif %}
            </span>
          </a>
        {% endif %}

        <a href="{{ routes.cart_url }}" class="header__icon main-overlay-header-icon-{{ overlay_id }} main-overlay-header-cart-icon-{{ overlay_id }}">
          <span class="icon-wrapper">
            {% if section.settings.custom_cart_icon %}
              {{ section.settings.custom_cart_icon | image_url: width: 30 | image_tag: alt: 'Cart', loading: 'lazy' }}
            {% else %}
              <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" focusable="false">
                <g transform="translate(0.5,0.5) scale(0.96)">
                  <path d="M7 18c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.19 2 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12L8.1 13h7.45c.75 0 1.41-.41 1.75-1.03L21.7 4H5.21l-.94-2H1zm16 16c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/>
                </g>
              </svg>
            {% endif %}
          </span>
        </a>
      </div>
    </div>
  </div>
</main-overlay-header-{{ overlay_id }}>

<script>
  (function() {
    class MainOverlayHeader{{ overlay_id }} extends HTMLElement {
      constructor() {
        super();
        this.hamburger = this.querySelector('.main-overlay-header-hamburger-{{ overlay_id }}');
        this.overlay = this.querySelector('.main-overlay-header-mobile-overlay-{{ overlay_id }}');
        this.mobileNavLinks = this.querySelectorAll('.main-overlay-header-mobile-nav-link-{{ overlay_id }}[data-has-dropdown="true"]');
        this.headerContainer = this.querySelector('.main-overlay-header-container-{{ overlay_id }}');
        this.updateOverlayOffset = this.updateOverlayOffset.bind(this);
        if (this.hamburger) {
          this.hamburger.setAttribute('aria-expanded', 'false');
        }
      }

      connectedCallback() {
        this.setupEventListeners();
        this.setupIconGradient();
        this.updateOverlayOffset();
        window.addEventListener('resize', this.updateOverlayOffset);
        window.addEventListener('scroll', this.updateOverlayOffset, { passive: true });
      }

      disconnectedCallback() {
        window.removeEventListener('resize', this.updateOverlayOffset);
        window.removeEventListener('scroll', this.updateOverlayOffset);

      }

      setupEventListeners() {
        if (this.hamburger && this.overlay) {
          this.hamburger.addEventListener('click', () => {
            this.toggleMobileMenu();
          });

          this.mobileNavLinks.forEach(link => {
            if (link.dataset.hasDropdown === 'true') {
              link.setAttribute('aria-expanded', 'false');
            }

            link.addEventListener('click', (e) => {
              if (link.dataset.hasDropdown === 'true') {
                e.preventDefault();
                this.toggleMobileDropdown(link);
              }
            });
          });

          this.overlay.addEventListener('click', (e) => {
            if (e.target === this.overlay) {
              this.closeMobileMenu();
            }
          });
        }
      }

      setupIconGradient() {
        this.iconGradient = this.querySelector('#mh-rainbow-icon-gradient-{{ overlay_id }}');
        this.headerIcons  = Array.from(this.querySelectorAll('.main-overlay-header-icon-{{ overlay_id }}'));
        if (!this.iconGradient || !this.headerIcons.length) return;

        const restartGradient = () => {
          this.iconGradient.classList.remove('mh-animate');
          void this.iconGradient.getBoundingClientRect();
          this.iconGradient.classList.add('mh-animate');
        };

        const prefersReduced = window.matchMedia &&
          window.matchMedia('(prefers-reduced-motion: reduce)').matches;

        this.headerIcons.forEach((icon) => {
          const activate = () => {
            icon.classList.add('mh-rainbow-active');
            if (!prefersReduced) restartGradient();
          };
          const deactivate = () => {
            icon.classList.remove('mh-rainbow-active');
          };

          icon.addEventListener('mouseenter', activate);
          icon.addEventListener('mouseleave', deactivate);
          icon.addEventListener('focus',     activate);
          icon.addEventListener('blur',      deactivate);
          icon.addEventListener('touchstart', () => {
            activate();
            setTimeout(deactivate, 400);
          }, { passive: true });
        });
      }

      toggleMobileMenu() {
        const isActive = !this.overlay.classList.contains('active');
        this.hamburger.classList.toggle('active', isActive);
        this.overlay.classList.toggle('active', isActive);
        this.hamburger.setAttribute('aria-expanded', isActive ? 'true' : 'false');
        this.updateOverlayOffset();
        document.body.style.overflow = isActive ? 'hidden' : '';
      }

      closeMobileMenu() {
        this.hamburger.classList.remove('active');
        this.overlay.classList.remove('active');
        this.hamburger.setAttribute('aria-expanded', 'false');
        this.updateOverlayOffset();
        document.body.style.overflow = '';
      }

      toggleMobileDropdown(link) {
        const dropdown = link.nextElementSibling;

        if (dropdown) {
          dropdown.classList.toggle('active');
          link.classList.toggle('active');
          const isOpen = dropdown.classList.contains('active');
          link.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
        }
      }

      updateOverlayOffset() {
        if (!this.overlay || !this.headerContainer) {
          return;
        }

        const headerRect = this.headerContainer.getBoundingClientRect();
        const clampedOffset = Math.min(Math.max(headerRect.bottom, 0), window.innerHeight);
        this.overlay.style.setProperty('--overlay-offset-{{ overlay_id }}', clampedOffset + 'px');
      }
    }

    if (!customElements.get('main-overlay-header-{{ overlay_id }}')) {
      customElements.define('main-overlay-header-{{ overlay_id }}', MainOverlayHeader{{ overlay_id }});
    }
  })();
</script>

<script>
  (function() {
    // Fallback initializer in case custom element upgrade is prevented
    const root = document.querySelector('main-overlay-header-{{ overlay_id }}[data-section-id="{{ section.id }}"]');
    if (!root || root.dataset.mhInit === '1') return;
    root.dataset.mhInit = '1';

    const btn = root.querySelector('.main-overlay-header-hamburger-{{ overlay_id }}');
    const overlay = root.querySelector('.main-overlay-header-mobile-overlay-{{ overlay_id }}');
    const headerContainer = root.querySelector('.main-overlay-header-container-{{ overlay_id }}');

    const update = () => {
      if (!overlay || !headerContainer) return;
      const rect = headerContainer.getBoundingClientRect();
      const clamped = Math.min(Math.max(rect.bottom, 0), window.innerHeight);
      overlay.style.setProperty('--overlay-offset-{{ overlay_id }}', clamped + 'px');
    };

    if (btn && overlay) {
      btn.setAttribute('aria-expanded', 'false');
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        const isActive = !overlay.classList.contains('active');
        btn.classList.toggle('active', isActive);
        overlay.classList.toggle('active', isActive);
        btn.setAttribute('aria-expanded', isActive ? 'true' : 'false');
        update();
        document.body.style.overflow = isActive ? 'hidden' : '';
      });

      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) {
          btn.classList.remove('active');
          overlay.classList.remove('active');
          btn.setAttribute('aria-expanded', 'false');
          document.body.style.overflow = '';
          update();
        }
      });

      window.addEventListener('resize', update);
      window.addEventListener('scroll', update, { passive: true });
      update();
    }
  })();
</script>

{% schema %}
{
  "name": "Main overlay header",
  "settings": [
    {
      "type": "header",
      "content": "Logo"
    },
    {
      "type": "image_picker",
      "id": "logo",
      "label": "Logo image"
    },
    {
      "type": "range",
      "id": "logo_height_mobile",
      "min": 20,
      "max": 80,
      "step": 5,
      "unit": "px",
      "label": "Logo height mobile",
      "default": 40
    },
    {
      "type": "range",
      "id": "logo_height_desktop",
      "min": 30,
      "max": 120,
      "step": 5,
      "unit": "px",
      "label": "Logo height desktop",
      "default": 60
    },
    {
      "type": "header",
      "content": "Navigation"
    },
    {
      "type": "link_list",
      "id": "menu",
      "label": "Menu",
      "default": "main-menu"
    },
    {
      "type": "range",
      "id": "nav_font_size_mobile",
      "min": 14,
      "max": 24,
      "step": 1,
      "unit": "px",
      "label": "Nav font size mobile",
      "default": 18
    },
    {
      "type": "range",
      "id": "nav_font_size_desktop",
      "min": 12,
      "max": 20,
      "step": 1,
      "unit": "px",
      "label": "Nav font size desktop",
      "default": 16
    },
    {
      "type": "select",
      "id": "nav_font_weight",
      "label": "Nav font weight",
      "options": [
        { "value": "400", "label": "Normal" },
        { "value": "500", "label": "Medium" },
        { "value": "600", "label": "Semi-bold" },
        { "value": "700", "label": "Bold" }
      ],
      "default": "500"
    },
    {
      "type": "range",
      "id": "nav_item_spacing_mobile",
      "min": 10,
      "max": 40,
      "step": 2,
      "unit": "px",
      "label": "Nav item spacing mobile",
      "default": 20
    },
    {
      "type": "range",
      "id": "nav_item_spacing_desktop",
      "min": 15,
      "max": 50,
      "step": 5,
      "unit": "px",
      "label": "Nav item spacing desktop",
      "default": 30
    },
    {
      "type": "range",
      "id": "nav_item_padding_mobile",
      "min": 5,
      "max": 20,
      "step": 1,
      "unit": "px",
      "label": "Nav item padding mobile",
      "default": 10
    },
    {
      "type": "range",
      "id": "nav_item_padding_desktop",
      "min": 5,
      "max": 20,
      "step": 1,
      "unit": "px",
      "label": "Nav item padding desktop",
      "default": 12
    },
    {
      "type": "range",
      "id": "nav_spacing_desktop",
      "min": 20,
      "max": 80,
      "step": 5,
      "unit": "px",
      "label": "Nav spacing from edges desktop",
      "default": 40
    },
    {
      "type": "header",
      "content": "Layout"
    },
    {
      "type": "range",
      "id": "header_height_mobile",
      "min": 60,
      "max": 100,
      "step": 5,
      "unit": "px",
      "label": "Header height mobile",
      "default": 70
    },
    {
      "type": "range",
      "id": "header_height_desktop",
      "min": 70,
      "max": 120,
      "step": 5,
      "unit": "px",
      "label": "Header height desktop",
      "default": 90
    },
    {
      "type": "range",
      "id": "header_margin_mobile",
      "min": 10,
      "max": 30,
      "step": 2,
      "unit": "px",
      "label": "Header margin mobile",
      "default": 16
    },
    {
      "type": "range",
      "id": "header_margin_desktop",
      "min": 15,
      "max": 50,
      "step": 5,
      "unit": "px",
      "label": "Header margin desktop",
      "default": 25
    },
    {
      "type": "range",
      "id": "overlay_padding_mobile",
      "min": 15,
      "max": 50,
      "step": 5,
      "unit": "px",
      "label": "Overlay padding mobile",
      "default": 25
    },
    {
      "type": "header",
      "content": "Colors"
    },
    {
      "type": "color",
      "id": "header_bg_color",
      "label": "Header background",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "header_border_color",
      "label": "Header border color",
      "default": "#e0e0e0"
    },
    {
      "type": "range",
      "id": "header_border_thickness",
      "min": 0,
      "max": 5,
      "step": 1,
      "unit": "px",
      "label": "Header border thickness",
      "default": 1
    },
    {
      "type": "color",
      "id": "nav_text_color",
      "label": "Nav text color",
      "default": "#121212"
    },
    {
      "type": "color",
      "id": "overlay_bg_color",
      "label": "Mobile overlay background",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "overlay_text_color",
      "label": "Mobile overlay text color",
      "default": "#121212"
    },
    {
      "type": "color",
      "id": "hamburger_color",
      "label": "Hamburger menu color",
      "default": "#121212"
    },
    {
      "type": "header",
      "content": "Dropdown"
    },
    {
      "type": "color",
      "id": "dropdown_bg_color",
      "label": "Dropdown background",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "dropdown_border_color",
      "label": "Dropdown border color",
      "default": "#e0e0e0"
    },
    {
      "type": "color",
      "id": "dropdown_text_color",
      "label": "Dropdown text color",
      "default": "#121212"
    },
    {
      "type": "color",
      "id": "dropdown_hover_bg_color",
      "label": "Dropdown hover background",
      "default": "#f5f5f5"
    },
    {
      "type": "color",
      "id": "dropdown_hover_text_color",
      "label": "Dropdown hover text color",
      "default": "#121212"
    },
    {
      "type": "range",
      "id": "dropdown_border_radius",
      "min": 0,
      "max": 15,
      "step": 1,
      "unit": "px",
      "label": "Dropdown border radius",
      "default": 4
    },
    {
      "type": "range",
      "id": "dropdown_font_size",
      "min": 12,
      "max": 18,
      "step": 1,
      "unit": "px",
      "label": "Dropdown font size",
      "default": 14
    },
    {
      "type": "range",
      "id": "dropdown_indent_mobile",
      "min": 10,
      "max": 40,
      "step": 2,
      "unit": "px",
      "label": "Dropdown indent mobile",
      "default": 20
    },
    {
      "type": "header",
      "content": "Icons"
    },
    {
      "type": "checkbox",
      "id": "show_search",
      "label": "Show search icon",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_account",
      "label": "Show account icon",
      "default": true
    },
    {
      "type": "image_picker",
      "id": "custom_search_icon",
      "label": "Custom search icon"
    },
    {
      "type": "image_picker",
      "id": "custom_account_icon",
      "label": "Custom account icon"
    },
    {
      "type": "image_picker",
      "id": "custom_cart_icon",
      "label": "Custom cart icon"
    },
    {
      "type": "image_picker",
      "id": "custom_caret_icon",
      "label": "Custom caret icon"
    },
    {
      "type": "range",
      "id": "icon_size_mobile",
      "min": 16,
      "max": 32,
      "step": 2,
      "unit": "px",
      "label": "Icon size mobile",
      "default": 24
    },
    {
      "type": "range",
      "id": "icon_size_desktop",
      "min": 18,
      "max": 36,
      "step": 2,
      "unit": "px",
      "label": "Icon size desktop",
      "default": 26
    },
    {
      "type": "range",
      "id": "icon_spacing",
      "min": 5,
      "max": 20,
      "step": 1,
      "unit": "px",
      "label": "Icon spacing",
      "default": 12
    },
    {
      "type": "range",
      "id": "icon_margin",
      "min": 0,
      "max": 10,
      "step": 1,
      "unit": "px",
      "label": "Icon margin",
      "default": 2
    },
    {
      "type": "header",
      "content": "Search icon colors"
    },
    {
      "type": "color",
      "id": "search_icon_color_mobile",
      "label": "Search icon color mobile",
      "default": "#121212"
    },
    {
      "type": "color",
      "id": "search_icon_hover_color_mobile",
      "label": "Search icon hover color mobile",
      "default": "#666666"
    },
    {
      "type": "color",
      "id": "search_icon_color_desktop",
      "label": "Search icon color desktop",
      "default": "#121212"
    },
    {
      "type": "color",
      "id": "search_icon_hover_color_desktop",
      "label": "Search icon hover color desktop",
      "default": "#666666"
    },
    {
      "type": "header",
      "content": "Account icon colors"
    },
    {
      "type": "color",
      "id": "account_icon_color_mobile",
      "label": "Account icon color mobile",
      "default": "#121212"
    },
    {
      "type": "color",
      "id": "account_icon_hover_color_mobile",
      "label": "Account icon hover color mobile",
      "default": "#666666"
    },
    {
      "type": "color",
      "id": "account_icon_color_desktop",
      "label": "Account icon color desktop",
      "default": "#121212"
    },
    {
      "type": "color",
      "id": "account_icon_hover_color_desktop",
      "label": "Account icon hover color desktop",
      "default": "#666666"
    },
    {
      "type": "header",
      "content": "Cart icon colors"
    },
    {
      "type": "color",
      "id": "cart_icon_color_mobile",
      "label": "Cart icon color mobile",
      "default": "#121212"
    },
    {
      "type": "color",
      "id": "cart_icon_hover_color_mobile",
      "label": "Cart icon hover color mobile",
      "default": "#666666"
    },
    {
      "type": "color",
      "id": "cart_icon_color_desktop",
      "label": "Cart icon color desktop",
      "default": "#121212"
    },
    {
      "type": "color",
      "id": "cart_icon_hover_color_desktop",
      "label": "Cart icon hover color desktop",
      "default": "#666666"
    },
    {
      "type": "header",
      "content": "Caret"
    },
    {
      "type": "range",
      "id": "caret_size",
      "min": 8,
      "max": 20,
      "step": 1,
      "unit": "px",
      "label": "Caret size",
      "default": 12
    },
    {
      "type": "range",
      "id": "caret_spacing",
      "min": 2,
      "max": 10,
      "step": 1,
      "unit": "px",
      "label": "Caret spacing",
      "default": 4
    },
    {
      "type": "range",
      "id": "caret_margin",
      "min": 0,
      "max": 10,
      "step": 1,
      "unit": "px",
      "label": "Caret margin",
      "default": 2
    }
  ],
  "presets": [
    {
      "name": "Main overlay header"
    }
  ]
}
{% endschema %}
